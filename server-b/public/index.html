<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–µ—Ä–≤–∏—Å B</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; padding: 0 15px; background: #fff0f5; }
    h1 { color: #a02c5a; }
    .section { background: white; padding: 15px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input, button { padding: 6px; margin: 4px; }
    button { background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button.delete { background: #d32f2f; padding: 4px 8px; }
    button.view { background: #1976d2; }
    button:hover { opacity: 0.9; }
    .log { background: #f9f9f9; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
    .entry { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
    .entry input { flex: 1; }
    h2 { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>üîµ –°–µ—Ä–≤–∏—Å B</h1>

  <!-- –õ–û–ö–ê–õ–¨–ù–´–ô –ö–≠–® -->
  <div class="section">
    <h2>üìÅ –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)</h2>
    <div class="entry">
      <input type="text" id="newLocalKeyB" placeholder="–ö–ª—é—á" />
      <input type="text" id="newLocalValueB" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" />
      <button onclick="addLocalEntry()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <button onclick="loadLocalKeys()">üîÉ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    <div id="localEntriesList"><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></div>
    <div class="log" id="localLogB">–î–µ–π—Å—Ç–≤–∏—è —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –∫—ç—à–µ–º...</div>
  </div>

  <!-- –û–ë–©–ò–ô –ö–≠–® -->
  <div class="section">
    <h2>üåê –û–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (<code>shared-data</code>)</h2>
    <div class="entry">
      <input type="text" id="newSharedKeyB" placeholder="–ö–ª—é—á" />
      <input type="text" id="newSharedValueB" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" />
      <input type="number" id="newSharedTtlB" placeholder="TTL (—Å–µ–∫)" value="60" min="1" style="width: 80px;" />
      <button onclick="addSharedEntry()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <button onclick="loadSharedKeys()">üîÉ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
    <div id="sharedEntriesList"><em>–ó–∞–≥—Ä—É–∑–∫–∞...</em></div>
    <div class="log" id="sharedLogB">–î–µ–π—Å—Ç–≤–∏—è —Å –æ–±—â–∏–º –∫—ç—à–µ–º...</div>
  </div>

  <script>
    function log(id, msg) {
      document.getElementById(id).textContent += `\n‚Üí ${msg}`;
    }

    // === –õ–û–ö–ê–õ–¨–ù–´–ô –ö–≠–® ===
    async function addLocalEntry() {
      const key = document.getElementById('newLocalKeyB').value.trim();
      const value = document.getElementById('newLocalValueB').value;
      if (!key) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á');
      try {
        const res = await fetch(`/local/${key}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        log('localLogB', `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${key} = "${value}"`);
        document.getElementById('newLocalKeyB').value = '';
        document.getElementById('newLocalValueB').value = '';
        loadLocalKeys();
      } catch (err) {
        log('localLogB', `–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function deleteLocal(key) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${key}" –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞?`)) return;
      try {
        const res = await fetch(`/local/${key}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        log('localLogB', `–£–¥–∞–ª–µ–Ω–æ: ${key}`);
        loadLocalKeys();
      } catch (err) {
        log('localLogB', `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function getLocal(key) {
      try {
        const res = await fetch(`/local/${key}`);
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON');
        }
        const data = await res.json();
        log('localLogB', `–õ–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${key} = ${JSON.stringify(data.value)}`);
      } catch (err) {
        log('localLogB', `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function loadLocalKeys() {
      const listEl = document.getElementById('localEntriesList');
      try {
        const res = await fetch('/local/keys');
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON');
        }
        const data = await res.json();
        const keys = Array.isArray(data.keys) ? data.keys : [];
        if (keys.length === 0) {
          listEl.innerHTML = '<em>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</em>';
          return;
        }
        listEl.innerHTML = keys.map(key => `
          <div class="entry">
            <strong>${key}</strong>
            <button class="view" onclick="getLocal('${key}')">üëÅÔ∏è</button>
            <button class="delete" onclick="deleteLocal('${key}')">√ó</button>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</em>';
        log('localLogB', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏: ${err.message}`);
      }
    }

    // === –û–ë–©–ò–ô –ö–≠–® ===
    async function addSharedEntry() {
      const key = document.getElementById('newSharedKeyB').value.trim();
      const value = document.getElementById('newSharedValueB').value;
      const ttl = parseInt(document.getElementById('newSharedTtlB').value) || 60;
      if (!key) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á');
      try {
        const res = await fetch(`/shared/${key}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value, ttl })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        log('sharedLogB', `–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ–±—â–∏–π –∫—ç—à: ${key} = "${value}" (TTL: ${ttl})`);
        document.getElementById('newSharedKeyB').value = '';
        document.getElementById('newSharedValueB').value = '';
        document.getElementById('newSharedTtlB').value = '60';
        loadSharedKeys();
      } catch (err) {
        log('sharedLogB', `–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function deleteShared(key) {
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${key}" –∏–∑ –û–ë–©–ï–ì–û –∫—ç—à–∞? –≠—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã!`)) return;
      try {
        const res = await fetch(`/shared/${key}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        log('sharedLogB', `–£–¥–∞–ª–µ–Ω–æ –∏–∑ –æ–±—â–µ–≥–æ –∫—ç—à–∞: ${key}`);
        loadSharedKeys();
      } catch (err) {
        log('sharedLogB', `–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function getShared(key) {
      try {
        const res = await fetch(`/shared/${key}`);
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON');
        }
        const data = await res.json();
        log('sharedLogB', `–û–±—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${key} = ${JSON.stringify(data.value)}`);
      } catch (err) {
        log('sharedLogB', `–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${err.message}`);
      }
    }

    async function loadSharedKeys() {
      const listEl = document.getElementById('sharedEntriesList');
      try {
        const res = await fetch('/shared/keys');
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON');
        }
        const data = await res.json();
        const keys = Array.isArray(data.keys) ? data.keys : [];
        if (keys.length === 0) {
          listEl.innerHTML = '<em>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</em>';
          return;
        }
        listEl.innerHTML = keys.map(key => `
          <div class="entry">
            <strong>${key}</strong>
            <button class="view" onclick="getShared('${key}')">üëÅÔ∏è</button>
            <button class="delete" onclick="deleteShared('${key}')">√ó</button>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<em>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</em>';
        log('sharedLogB', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á–∏: ${err.message}`);
      }
    }

    loadLocalKeys();
    loadSharedKeys();
  </script>
</body>
</html>